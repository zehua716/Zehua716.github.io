<!DOCTYPE html>
<html lang="zh" dir="ltr">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>论文阅读 - DiffuseVAE 详解 | 主页</title>
<meta name="keywords" content="机器学习, 生成模型, 统计分析">
<meta name="description" content="DiffuseVAE
背景问题：

扩散模型：生成质量高，但存在两个缺点：① 缺乏低维、可解释的潜在空间；② 生成速度较慢。
VAE：具有低维潜在空间，可以解释和操控生成，但生成图像质量较差。

因此提出了 DiffuseVAE，将VAE嵌入到扩散模型框架中，并设计了新的条件参数化方法，使扩散模型能够利用VAE推导的低维潜在编码。在标准基准（如 CIFAR-10 和 CelebA-64）上，生成质量优于大多数基于 VAE 的方法，并与最先进模型接近，并独特地保留了对低维潜在空间的访问能力，这是其他模型没有的。">
<meta name="author" content="zehua">
<link rel="canonical" href="http://zehua.eu/zh/posts/machinelearning_cn/diffusevae%E7%BD%91%E7%AB%99%E7%89%88/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.0aec493a8d0485b0d85dd4e2e2ea202a2a2954009c175e96830de67966b695f3.css" integrity="sha256-CuxJOo0EhbDYXdTi4uogKiopVACcF16Wgw3meWa2lfM=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://zehua.eu/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://zehua.eu/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://zehua.eu/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://zehua.eu/apple-touch-icon.png">
<link rel="mask-icon" href="http://zehua.eu/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://zehua.eu/zh/posts/machinelearning_cn/diffusevae%E7%BD%91%E7%AB%99%E7%89%88/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"
    integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
    integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx"
    crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
    integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
    crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true }
            ],
            
            throwOnError: false
        });
    }); 
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

<meta property="og:title" content="论文阅读 - DiffuseVAE 详解" />
<meta property="og:description" content="DiffuseVAE
背景问题：

扩散模型：生成质量高，但存在两个缺点：① 缺乏低维、可解释的潜在空间；② 生成速度较慢。
VAE：具有低维潜在空间，可以解释和操控生成，但生成图像质量较差。

因此提出了 DiffuseVAE，将VAE嵌入到扩散模型框架中，并设计了新的条件参数化方法，使扩散模型能够利用VAE推导的低维潜在编码。在标准基准（如 CIFAR-10 和 CelebA-64）上，生成质量优于大多数基于 VAE 的方法，并与最先进模型接近，并独特地保留了对低维潜在空间的访问能力，这是其他模型没有的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://zehua.eu/zh/posts/machinelearning_cn/diffusevae%E7%BD%91%E7%AB%99%E7%89%88/" />
<meta property="og:image" content="http://zehua.eu/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-27T16:25:17+01:00" />
<meta property="article:modified_time" content="2024-11-27T17:12:35+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://zehua.eu/images/papermod-cover.png" />
<meta name="twitter:title" content="论文阅读 - DiffuseVAE 详解"/>
<meta name="twitter:description" content="DiffuseVAE
背景问题：

扩散模型：生成质量高，但存在两个缺点：① 缺乏低维、可解释的潜在空间；② 生成速度较慢。
VAE：具有低维潜在空间，可以解释和操控生成，但生成图像质量较差。

因此提出了 DiffuseVAE，将VAE嵌入到扩散模型框架中，并设计了新的条件参数化方法，使扩散模型能够利用VAE推导的低维潜在编码。在标准基准（如 CIFAR-10 和 CelebA-64）上，生成质量优于大多数基于 VAE 的方法，并与最先进模型接近，并独特地保留了对低维潜在空间的访问能力，这是其他模型没有的。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://zehua.eu/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "机器学习",
      "item": "http://zehua.eu/zh/posts/machinelearning_cn/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "论文阅读 - DiffuseVAE 详解",
      "item": "http://zehua.eu/zh/posts/machinelearning_cn/diffusevae%E7%BD%91%E7%AB%99%E7%89%88/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "论文阅读 - DiffuseVAE 详解",
  "name": "论文阅读 - DiffuseVAE 详解",
  "description": "DiffuseVAE 背景问题： 扩散模型：生成质量高，但存在两个缺点：① 缺乏低维、可解释的潜在空间；② 生成速度较慢。 VAE：具有低维潜在空间，可以解释和操控生成，但生成图像质量较差。 因此提出了 DiffuseVAE，将VAE嵌入到扩散模型框架中，并设计了新的条件参数化方法，使扩散模型能够利用VAE推导的低维潜在编码。在标准基准（如 CIFAR-10 和 CelebA-64）上，生成质量优于大多数基于 VAE 的方法，并与最先进模型接近，并独特地保留了对低维潜在空间的访问能力，这是其他模型没有的。\n",
  "keywords": [
    "机器学习", "生成模型", "统计分析"
  ],
  "articleBody": "DiffuseVAE 背景问题： 扩散模型：生成质量高，但存在两个缺点：① 缺乏低维、可解释的潜在空间；② 生成速度较慢。 VAE：具有低维潜在空间，可以解释和操控生成，但生成图像质量较差。 因此提出了 DiffuseVAE，将VAE嵌入到扩散模型框架中，并设计了新的条件参数化方法，使扩散模型能够利用VAE推导的低维潜在编码。在标准基准（如 CIFAR-10 和 CelebA-64）上，生成质量优于大多数基于 VAE 的方法，并与最先进模型接近，并独特地保留了对低维潜在空间的访问能力，这是其他模型没有的。\nVAE和扩散模型的优缺点 VAE 的特点：\n显式似然生成模型：以概率分布的方式描述数据生成过程。 低维潜在表示：通过学习隐空间表示，可以捕捉数据的结构和特征。 灵活性：适用于多种任务，包括： 解耦表示学习（分离数据中的不同特征）。 半监督学习（结合少量有标注数据进行学习）。 异常检测（识别偏离正常分布的样本）。 VAE 的局限性：\n模糊的生成样本：生成图像往往缺乏高频细节和清晰度。 结构复杂性：最近的一些改进（如层次化潜在结构）尽管提高了生成质量，但增加了模型复杂度（需要大规模的潜在代码层次化结构）。 与GAN的差距：相比隐式生成模型（如GAN），VAE在样本质量上仍显逊色，特别是在视觉感知方面。 扩散模型（DDPM）的优势和局限性：\n生成质量高：在多个图像合成任务中表现优异，甚至在某些基准上超越了GANs。 高昂的计算成本：生成样本时需要多次迭代的逐步采样过程，计算开销大，生成速度慢。 缺乏低维潜在表示：无法像VAE那样学习和利用低维潜在空间，这限制了其在某些下游任务（如表示解耦、异常检测、可控生成）中的应用。 VAE和DDPM复习回顾 变分自编码器 (VAE ) VAE 是一种利用深度神经网络进行变分推断的生成模型，使用编码器将数据 $x$ 映射到潜在空间表示 $z$，再通过解码器从 $z$ 重建 $x$。它通过最大化数据对数似然 $\\log p(x)$ 来学习模型，但由于直接计算对数似然通常不可行，VAE 使用 证据下界（ELBO） 来近似优化。\nVAE 的损失函数（ELBO）定义如下： $$ \\mathcal{L}(\\theta, \\phi) = \\underbrace{\\mathbb{E}{q\\phi(z|x)}[\\log p_\\theta(x|z)]}{\\text{重建误差}} - \\underbrace{D{KL}[q_\\phi(z|x) | p(z)]}_{\\text{KL 散度正则化}} $$ 为了使模型的优化过程可微分，VAE 引入了重参数化技巧，将采样过程从随机变量 $z$ 中分离。例如，将随机变量 $z$ 表示为 $z = \\mu + \\sigma \\cdot \\epsilon$，其中 $\\epsilon$ 是从标准正态分布采样的噪声。默认先验分布 $p(z)$ 通常设为标准高斯分布，但可以扩展到更复杂的分布（如混合分布或归一化流）以提升模型的表达能力。\n更详细内容请看 VAE\nDDPM DDPM 是一种基于潜变量的生成模型， 利用正向过程将数据逐步加噪到高斯分布，再通过逆向过程从噪声中逐步还原数据。包含两个过程：\n正向加噪过程 通过一个固定的高斯马尔可夫链，逐步对数据 $x_0$ 加噪，使其最终接近各向同性高斯分布。正向过程的核心是逐步破坏数据结构，每一步的加噪过程使用高斯分布： $$ q(x_{1:T}|x_0) = \\prod_{t=1}^{T} q(x_t|x_{t-1}) $$ 这意味着当前状态 $x_t$ 仅依赖于前一个状态 $x_{t-1}$，整个加噪过程的联合分布可以通过各步的条件分布相乘得到，每一步的加噪过程由高斯分布建模： $$ q(x_t|x_{t-1}) = \\mathcal{N}(\\sqrt{1-\\beta_t}x_{t-1}, \\beta_t\\mathbf{I}) $$\n其中 $\\beta_t$ 是噪声调度参数，决定每一步加噪的程度。 通过数学推导，可以从原始数据 $x_0$ 直接生成第 $t$ 步数据： $$ q(x_t|x_0) = \\mathcal{N}(\\sqrt{\\bar{\\alpha}_t}x_0, (1-\\bar{\\alpha}_t)\\mathbf{I}) $$\n其中 $\\bar{\\alpha}t = \\prod{i=1}^t (1-\\beta_i)$ 是累积衰减系数。 正向过程是固定的，不需要学习，最终会将数据 $x_0$ 转化为接近高斯分布的 $x_T$。\n逆向去噪过程 逆向过程试图逐步还原数据，采用可学习的高斯马尔可夫链： $$ p_\\theta(x_{t-1}|x_t) = \\mathcal{N}(\\mu_\\theta(x_t, t), \\Sigma_\\theta(x_t, t)) $$\n其中均值 $\\mu_\\theta$ 和协方差 $\\Sigma_\\theta$ 是通过神经网络学习的。 采样时，先从 $p(x_T)$（通常选为各向同性高斯分布）中采样一个噪声向量，再运行逆向过程逐步去噪，生成最终样本 $x_0$。\n噪声调度参数 $\\beta_t$ 是正向加噪过程的核心，影响生成样本的质量和采样速度。可以是固定值，也可以通过优化学习得到。整个模型通过变分推断优化，目标是最小化正向过程和逆向过程的分布差异。\nDDPM 主要优势是生成样本质量高，但缺点是采样速度较慢（需要多次迭代）。这是许多扩散模型后续改进的基础，例如提高采样效率的 DDIM。\nDiffuseVAE: VAE与扩散模型的结合 提出的 DiffuseVAE 将 VAE 和 DDPM 结合，使生成过程既拥有 VAE 提供的低维潜在空间，又有 DDPM 生成高质量细节的能力。框架中通过两阶段建模，先利用 VAE 的低维潜在空间对样本进行全局特征建模生成粗略样本，再用 DDPM 细化提高质量。通过两阶段建模解决了 VAE 样本模糊和 DDPM 缺乏低维表示的问题。\n算法框架： 该框架可归纳为生成器-细化器框架\n生成器：第一阶段通过VAE 对训练数据 $x$ 拟合，生成重构样本 $\\hat{x}$。 细化器：第二阶段通过条件 DDPM 对 VAE 的重构样本 $\\hat{x}$ 进行细化建模，从而生成更高质量的样本。 **第一阶段 **：VAE 建模\n给定训练数据 $(x_0, y)$，其中 $x_0$ 是高分辨率数据（例如图像），$y$ 是辅助条件信号（例如一些特征描述信息）。\n编码器：从 $(x_0, y)$ 中提取潜在表示 $z$，即 $q_\\psi(z|y, x_0)$。这是一种条件后验分布，因为在给定 $(y,x_0)$ 的条件下，我们对 $z$ 的分布进行估计。 解码器：在给定 $z$ 的前提下生成 $y$，即 $p_\\theta(y|z)$。这里 $y$ 是由潜在表示 $z$ 解码而来的。 注意，这里 VAE 最后的输出不是直接生成 $x_0$ ，而是生成 条件辅助信号 $y$ ，随后我们会在第二阶段使用扩散模型来从 $y$ 和 $z$ 再还原出 $x_0$ ，即生成 $x_0$ 是扩散模型DDPM算法的任务。形象一点来讲，VAE 的作用是给DDPM提供一个充满了信息（潜在特征）的藏宝图（低维潜在空间），真正一步步（逐渐加噪去噪）找到宝藏（恢复图片）还是要靠DDPM算法来实现\n第二阶段：DDPM 建模\n在有了 VAE 产生的条件信号 $y$ 以及对应的潜在表示 $z$ 后，我们利用条件扩散模型（DDPM）从 $y,z$ 出发，对 $x_0$ 进行细化生成。\n这里和单纯扩散模型DDPM算法过程类似，依旧是加噪和去噪过程\n前向加噪过程：\n从真实数据 $x_0$ 开始，不断向其添加噪声，经过 $T$ 步得到一系列加噪样本 $x_{1:T}$。这一过程用 $q(x_{1:T}|y,z,x_0)$ 表示，该分布是已知的（通常是固定高斯加噪过程）。\n逆向去噪过程：\n扩散模型要学习从纯噪声逐步去噪回到 $x_0$ 的逆向分布 $p_\\phi(x_{0:T}|y,z)$。这里 $p_\\phi$ 由参数 $\\phi$ 决定，需要通过训练来拟合。在条件 $y$ 和潜在表示 $z$ 下逐步还原出 $x_0$。\n这里需要从真实数据 $x_0$ 开始加噪，然后得到 $x_{1:T}$ ，这里从真实数据开始而不是直接从 $y,z$ 开始的原因是；真实数据提供了逆向去噪的正确答案，即当我们用真实数据加噪后，逆向去噪应该能从 $x_T$ 最终得到原始的 $x_0$，那么就说明去噪过程是正确的。\n![image-20241211100919496](/Users/zehua/Library/Application Support/typora-user-images/image-20241211100919496.png)\nDiffuseVAE 的低维潜在空间能够捕捉生成样本的全局特征(内容、形状或结构)，这就意味着用户可以通过修改这个潜在空间中的变量来直接影响生成样本的主要特性。并且 DiffuseVAE 在速度和质量之间取得了更好的平衡。例如，仅需 10 步采样就能生成质量合理的样本，比传统 DDPM 的效率更高，且生成效果优于相同采样次数的其他方法（如 DDIM）。DiffuseVAE 经过预训练后，对条件信号中的不同噪声类型表现出较好的泛化能力，证明其框架不仅适合特定场景，还能应对多种不确定性条件。\n数学理论 元素表达 $x_0$：我们想生成的高分辨率图像； $y$：通过 VAE 建模的辅助条件信号； $z$：与 $y$ 相关联的潜在表示； $x_{1:T}$：扩散模型学习到的 $T$ 个加噪表示。 $\\hat{x}_0$ : VAE 的重构图像 联合分布的分解 $$ p(x_{0:T}, y, z) = p(z)p_\\theta(y|z)p_\\phi(x_{0:T}|y, z) $$\n$p(z)$ 是潜在变量的先验分布，通常设为标准高斯分布；\n$p_\\theta(y|z)$ 表示在潜在变量 $z$ 下生成条件信号 $y$ 的概率，这是由 VAE 的解码器学习到的；\n$p_\\phi(x_{0:T}|y, z)$ 是扩散模型的逆向去噪过程，用来从条件信号 $y$ 和潜在表示 $z$ 逐步恢复数据。\n后验分布的近似 在给定数据 $(x_0, y)$ 的情况下，潜在表示 $z$ 和中间加噪样本 $x_{1:T}$ 的后验分布： $$ p(x_{1:T}, z|y, x_0) $$ 该后验分布没有显式解析解，于是我们用一个近似分布 $q(x_{1:T}, z|y, x_0)$ 来替代： $$ q(x_{1:T}, z|y, x_0) = q_\\psi(z|y, x_0)q(x_{1:T}|y, z, x_0) $$\n这里的近似分布由两部分构成：\n$q_\\psi(z|y, x_0)$ 是 VAE 的识别网络，它负责从 $y$ 和 $x_0$ 中推断潜在变量 $z$\n$q(x_{1:T}|y, z, x_0)$ 是扩散模型的前向加噪过程，从 $x_0$ 开始加噪到 $x_{1:T}$。这个分布是已知且不需要参数化，因为前向过程是人为设定的加噪机制。\n因此我们将复杂的后验分布分解成了两部分：一部分是 VAE 的后验（学习 $z$），另一部分是一个确定的加噪过程（生成 $x_{1:T}$）\n数据对数似然 我们的最终目标是最大化数据 $(x_0, y)$ 的对数似然 $\\log p(x_0, y)$： $$ \\log p(x_0, y) = \\log \\int p(x_{0:T}, y, z) dx_{1:T} dz $$ 这表示，我们需要对联合分布 $p(x_{0:T}, y, z)$ 进行积分，边缘化掉 $x_{1:T}$ 和 $z$。但是，和 VAE 情况类似，在实际中非常困难计算，为此，我们引入了 证据下界(ELBO) 来对 $\\log p(x_0, y)$ 进行下界估计，以便通过优化 ELBO 来最大化 $\\log p(x_0, y)$。\n证据下界（ELBO） ELBO 的定义是： $$ \\begin{aligned} \\log p(x_0, y) \\geq \u0026 \\underbrace{\\mathbb{E}{q\\psi(z|y,x_0)} \\big[ p_\\theta(y|z) \\big] - \\mathcal{D}{KL} \\big(q\\psi(z|y,x_0) | p(z)\\big)}{\\mathcal{L}{\\text{VAE}}}\n\\mathbb{E}{z \\sim q(z|y,x_0)} \\left[\\underbrace{ \\mathbb{E}{q(x_{1:T}|y,z,x_0)} \\left[ \\frac{p_\\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)} \\right] }{\\mathcal{L}{\\text{DDPM}}}\\right] \\end{aligned} $$ 证明\n我们希望最大化数据 $(x_0,y)$ 的对数似然： $$ \\log p(x_0,y) = \\log \\int p(x_{0:T}, y, z) ,dx_{1:T},dz $$\n这里 $x_{1:T}$ 和 $z$ 是潜在变量（未观测量），直接求解该对数似然通常非常困难。\n步骤1：引入近似分布\n为了对上述不可直接计算的积分进行处理，我们引入两个近似后验分布：\n$q_\\psi(z|y,x_0)$：用于逼近真实后验 $p(z|x_0,y)$ $q(x_{1:T}|y,z,x_0)$：用于逼近真实加噪过程的后验（在此情况中，它往往是定义好的正向加噪过程，而非需近似的；这里更多是从数学形式上刻画）。 有了这两个分布，我们可在对数似然中乘以1的巧妙形式： $$ 1 = \\frac{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)} $$\n将此代入后得到： $$ \\log p(x_0,y) = \\log \\int p(x_{0:T}, y, z) \\frac{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)} ,dx_{1:T},dz $$\n步骤2：期望形式表示\n将积分形式转换为期望的概率表示： $$ \\log p(x_0,y) = \\log \\mathbb{E}{q\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\\left[ \\frac{p(x_{0:T}, y, z)}{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)} \\right] $$\n现在我们有期望的结构，可以使用 Jensen’s inequality（詹森不等式）对对数的期望下界化。\n步骤3：应用 Jensen’s inequality 获得ELBO下界\n对于任意随机变量 $X$ 和凹函数 $\\log(\\cdot)$，詹森不等式有： $$ \\log \\mathbb{E}[X] \\geq \\mathbb{E}[\\log X] $$\n将其应用于上式： $$ \\log p(x_0,y) \\geq \\mathbb{E}{q\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\\left[\\log \\frac{p(x_{0:T}, y, z)}{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\\right] $$\n这就得到了所谓的ELBO（下界）。\n步骤4：分解联合分布 $p(x_{0:T}, y, z)$\n对联合分布使用给定模型的分解方式： $$ p(x_{0:T}, y, z) = p(z)p_\\theta(y|z)p_\\phi(x_{0:T}|y,z) $$\n代入后： $$ \\log p(x_0,y) \\geq \\mathbb{E}{q\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\\left[\\log \\frac{p(z)p_\\theta(y|z)p_\\phi(x_{0:T}|y,z)}{q_\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\\right] $$\n将对数展开为加法： $$ = \\mathbb{E}{q\\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\\left[\\log p_\\theta(y|z) + \\log p_\\phi(x_{0:T}|y,z) + \\log p(z) - \\log q_\\psi(z|y,x_0) - \\log q(x_{1:T}|y,z,x_0)\\right] $$\n把联合期望写成双重期望的形式，我们得到: $$ \\log p(x_0,y) \\geq \\mathbb{E}{q\\psi(z|y,x_0)}\\mathbb{E}{q(x{1:T}|y,z,x_0)}[\\log p_\\theta(y|z) + \\log p_\\phi(x_{0:T}|y,z) + \\log p(z) - \\log q_\\psi(z|y,x_0) - \\log q(x_{1:T}|y,z,x_0)] $$\n步骤5：分离VAE部分与DDPM部分\n观察上述期望，我们可将其分为两部分：\n仅与 $z$ 有关的项（VAE相关项）： $$ \\mathbb{E}{q\\psi(z|y,x_0)}[\\log p_\\theta(y|z) + \\log p(z) - \\log q_\\psi(z|y,x_0)] $$\n此处用标准的VAE推导可知，这部分是VAE的ELBO形式：\n$\\log p_\\theta(y|z)$ 是重建项 $-\\log q_\\psi(z|y,x_0)$ 与 $\\log p(z)$ 组合后给出KL散度约束项（$-D_{KL}[q_\\psi(z|y,x_0)||p(z)]$） 整合后，这部分为： $$ \\mathcal{L}{\\text{VAE}} = \\mathbb{E}{q_\\psi(z|y,x_0)}[\\log p_\\theta(y|z)] - D_{KL}[q_\\psi(z|y,x_0) | p(z)] $$\n与扩散过程相关的项（DDPM相关项）： $$ \\mathbb{E}{z \\sim q\\psi(z|y,x_0)}\\left[\\mathbb{E}{q(x{1:T}|y,z,x_0)}[\\log p_\\phi(x_{0:T}|y,z) - \\log q(x_{1:T}|y,z,x_0)]\\right] $$\n注意到 $\\log p_\\phi(x_{0:T}|y,z) - \\log q(x_{1:T}|y,z,x_0)$ 可以进一步写成对数比： $$ \\mathbb{E}{q(x{1:T}|y,z,x_0)}\\left[\\log \\frac{p_\\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)}\\right] $$\n将此部分定义为扩散模型相关的ELBO项： $$ \\mathcal{L}{\\text{DDPM}} = \\mathbb{E}{q(x_{1:T}|y,z,x_0)}\\left[\\log \\frac{p_\\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)}\\right] $$\n因此，最终得到的ELBO表达式为： $$ \\log p(x_0,y) \\geq \\underbrace{\\mathbb{E}{q\\psi(z|y,x_0)}[\\log p_\\theta(y|z)] - D_{KL}[q_\\psi(z|y,x_0) | p(z)]}{\\mathcal{L}{\\text{VAE}}}\n\\mathbb{E}{z \\sim q\\psi(z|y,x_0)}\\left[ \\underbrace{\\mathbb{E}{q(x{1:T}|y,z,x_0)}\\left[\\log \\frac{p_\\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)}\\right]}{\\mathcal{L}{\\text{DDPM}}}\\right] $$ 证毕\n上式可以分为两大部分：\nVAE 部分 ($\\mathcal{L}_{\\text{VAE}}$)： $$ \\mathcal{L}{\\text{VAE}} = \\mathbb{E}{q_\\psi(z|y,x_0)} \\big[ p_\\theta(y|z) \\big] - \\mathcal{D}{KL} \\big(q\\psi(z|y,x_0) | p(z)\\big) $$\n这是标准的 VAE 损失项，包括一个重构项（期望条件下 $z$ 对 $y$ 的重构对数似然）以及 KL 散度项（约束 $q_\\psi(z|y,x_0)$ 接近先验 $p(z)$）。 VAE 部分的优化确保了潜在空间 $z$ 有意义，同时能让解码器在给定 $z$ 的情况下生成合理的 $y$。 DDPM 部分 ($\\mathcal{L}_{\\text{DDPM}}$)： $$ \\mathbb{E}{z \\sim q(z|y,x_0)} \\left[\\underbrace{ \\mathbb{E}{q(x_{1:T}|y,z,x_0)} \\left[ \\frac{p_\\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)} \\right] }{\\mathcal{L}{\\text{DDPM}}}\\right] $$\n要理解这个公式，首先我们需要回顾 DDPM 的背景:\n在 DiffuseVAE 的框架中，$x_{1:T}$ 是扩散模型引入的中间加噪步骤，也就是从 $x_0$ 不断加噪直到几乎变成高斯噪声的过程。这里有两个分布很重要：\n​\t(a) 正向加噪过程 $q(x_{1:T}|y,z,x_0)$：\n这个过程是已知且固定的（通常我们设计一个固定的加噪策略）。给定真实数据 $x_0$、潜在变量 $z$ 和条件信息 $y$，我们能确定如何一步步往数据里加噪得到 $x_{1:T}$。该分布不需要学习，因为加噪规则是人定义的。\n​\t(b) 逆向去噪过程 $p_\\phi(x_{0:T}|y,z)$：\n这个过程是模型需要学习的，即从纯噪声（或高度加噪的 $x_T$）一步步“去噪”回 $x_0$ 的概率分布。该分布由参数 $\\phi$ 控制，通过神经网络拟合。如果参数 $\\phi$ 拟合的好，说明 $p_\\phi$ 完美匹配了真正的逆向分布，那么说明可以从噪声逆推回真实数据 $x_0$\n再重新看这个公式，它分为内层期望和外层期望两部分\n内层期望： $$ \\mathbb{E}{q(x{1:T}|y,z,x_0)} \\left[ \\frac{p_\\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)} \\right] $$\n分子 $p_\\phi(x_{0:T}|y,z)$：希望从噪声出发还原数据的模型分布。 分母 $q(x_{1:T}|y,z,x_0)$：这是数据真实加噪时的分布。 如果他们两个的比值期望大，那么说明逆向过程越好（因为真实加噪过程和真实逆向过程是正好相反的，如果模拟逆向过程等于真实逆向过程，那么这个差值最大期望最大），相反，如果 $p_\\phi$ 和 $q$ 不匹配，这个期望值就会偏小。换句话说，这个期望项在测量 $p_\\phi$ 与 $q$ 的吻合程度\n外层期望：\n在上面讨论的内层期望中，我们是固定 $z$ 来看问题。但是 $z$ 本身是由 $q_\\psi(z|y,x_0)$ 给定的（VAE的后验分布）。我们希望无论 $z$ 如何变化，模型都能保证逆向过程 $p_\\phi$ 与正向过程 $q$ 匹配。\n因此我们对 $z$ 的分布再求一个期望，这样就可以确保扩散模型在整个潜在空间分布下（即对各种可能的全局特征）都能完成从噪声到 $x_0$ 的还原。这保证了模型的普适性，即对各类潜在表征都能有效地还原数据。\n综上所述，内层期望是在问：如果按照正向过程 $q$ 的方式对 $x_0$ 加了噪声，那么逆向过程 $p_\\phi$ 能否以高概率还原这个加噪后的样本到原始数据 $x_0$？如果能，这个比值就高，期望就大。外层期望再考虑对所有可能的 $z$ 做平均，以确保无论潜在表征是什么，模型都能完成这个逆向还原。因此，通过优化这个期望，我们就能让 $p_\\phi$ 更好地匹配 $q$ 的逆过程，从而在训练中“教会”扩散模型如何去噪回到 $x_0$。\n最后，ELBO 即为两部分之和：\n$$ \\log p(x_0, y) \\geq \\mathcal{L}{\\text{VAE}} + \\mathbb{E}{z \\sim q(z|y,x_0)}[\\mathcal{L}_{\\text{DDPM}}] $$\n这为联合训练提供了一个可优化的目标函数。\n总的来说，DiffuseVAE 的训练目标通过联合分布、后验分布近似以及 ELBO 分解，将 VAE 和扩散模型的损失函数结合起来。这个设计不仅让模型能够生成高质量的样本，还利用了低维潜在空间，提升了生成的控制性和效率。训练过程中，VAE 负责潜在表示的学习，扩散模型负责生成过程的细节还原，两者相辅相成。\n简化设计 条件信号 $y$ 的简化 在原始 DiffuseVAE 的设计中，$y$ 是一个与 $x_0$​ 有关但不完全等同的条件信号。这样做的目的是为扩散模型提供附加条件，从而在逆向去噪过程中能够利用这些信息对生成样本进行更精细的控制。然而，这种设计在实际实现中可能会变得复杂：\n模型需要在去噪的每个步骤处理 $(y,z)$ 的条件信息，这增加了运算和实现上的难度。 $y$ 的选取和设计也会影响最终模型的性能与适用性，开发者需要思考如何选择合适的 $y$。 因此做了一个重要简化，假设 $y = x_0$，也就是说，条件信号直接等于目标图像本身。我们简单来解释他，我们最开始的假想是在去噪的过程中额外输入一个与 $x_0$ 有关但不同的 $y$ 作为去噪的补充信息，比如说，VAE 生成了一个图像，模模糊糊的，我们现在告诉他，你要生成的应该是一只猫，现在我们做了这个简化，相当于去掉了补充信息，而直接将原图像作为补充信息，换句话说，直接给去噪过程标准答案，告诉他，你应该生成的就是这个猫图像类似的新图像。相当于压根就没有什么 $y$ ，研究到最后发现 $y$ 这个创新点没用，但是提都提了，就这么草率的把输入图像作为补充信息了。其实本质上就是用了两次输入图像，一份用来给 VAE 提取特征，一份给DDPM 作为参考答案\n潜在表示 $z$ 的简化 潜在表示$z$ 是由 VAE 编码器从 $(x_0)$ 中获得的潜在表示。在原本的框架中，扩散模型可能需要同时考虑 $(y,z)$ 的条件输入，这意味着扩散模型输入要依赖潜在空间的表达，但是把一个潜在空间作为输入怎么做？没法做! 这就是为什么对潜在空间 $z$ 进行了简化。\n简化思路是：既然 $z$ 是从 $x_0$ 映射得到的，那么 VAE 的解码器在给定 $z$ 时生成的 $\\hat{x}_0$ 已经是 $z$ 的一个确定性函数。也就是说，$\\hat{x}_0$ 完整地代表了 $z$ 中包含的信息。这就使得扩散模型可以直接使用 $\\hat{x}_0$ 作为条件参考，而无需显式地输入 $z$。\n我们还是简单的来解释他，其实思路是非常漂亮的，通过 VAE 得到输入，再传给 Diffusion 相当于引入了潜在空间，让 diffusion 充分利用潜在空间，完美的符合了DiffuseVAe 的思想，但是实际实现不出来，因为潜在空间不不是一个显式的数据集，是一个难啃的生数据，我们在 Diffusion 中用不了它，要想用，还是得在 VAE 中把 $z$ 转换成 $\\hat{x}_0$ ，这样扩散模型接收的依旧是“图像形式”的条件，而不是抽象的潜在矢量。本质上是什么，本质上就是把 VAE 得到的结果输入给 DDPM 就是这么简单，DDPM中根本就没用潜在空间。\n两阶段独立训练的简化 原本的想法是联合训练 VAE 部分（负责 $z$ 的学习和 $y$ 的重构）以及扩散部分（负责对重构样本做细化），这样可以在理论上实现一个端到端训练：模型同时学会提取潜在表示和利用扩散模型从潜在表示中生成高质量图像。但是! 联合训练在实际实现中非常复杂，参数多，计算量大，互为条件环路，即VAE 的输出是扩散模型的输入，扩散模型的性能又影响 VAE 的参数搜索空间，非常容易导致训练不稳定\n为了简化训练过程，我们采用了顺序的两阶段训练方法：\n第一阶段只训练 VAE，学会从 $x_0$ 中提取潜在表示 $z$ 并重构出 $\\hat{x}_0$。这一步本质是一个标准的 VAE 训练任务，优化相对简单。 第二阶段固定 VAE 的参数（不再训练），只使用 VAE 训练好的模型表示。然后再单独运行扩散模型，这样就不会被 VAE 的动态变化扰动。 说明了什么，说明了之前说的端对端联合优化没能实现，还是只能使用传统思想，固定一个，训练另一个，VAE 提供一个初步结果，而 DDPM 专注于细化这些结果，从而结合两者的优势。\n总结一下这三点简化 条件信号 $y$ 被简化为目标数据 $x_0$\n第二阶段扩散模型的输入是 VAE 重构结果 $\\hat{x}_0$\n使用顺序的两阶段训练方式，固定一个，训练另一个\n从这里我们可以看出，理论很美好，实践很困难啊!\nVAE 参数化的选择 在 VAE 的选择上，论文决定只使用最基本、最传统的 VAE 构型（单随机层的简单 VAE），而不是使用更复杂的多层变种：\n使用复杂的 VAE（比如多层潜在变量、多级别特征抽取）可以潜在地获得更强大的表示能力，但也会使潜在空间更难解释、更不稳定，从而不利于对潜在表示 $z$ 的直观控制和理解。 简单的 VAE 虽然表达能力或许弱一些，但潜在空间更易于理解和利用，符合 DiffuseVAE 利用潜在空间来控制全局特性的初衷。 DDPM扩散模型两种设计假设 在将 VAE 重构的 $\\hat{x}_0$ 与扩散模型相结合时，有两种主要的设计思路（两种公式假设），分别在正向与逆向过程的依赖关系上做出了不同的简化。\n第一种简化假设： 正向过程的条件独立性：\n假设正向加噪过程 $q(x_{1:T}|x_0,z)$ 对 $z$ 和 $\\hat{x}0$ 条件独立，也就是正向过程不需要使用 $z$ 或 $\\hat{x}0$的信息，只从原始数据 $x_0$ 通过标准扩散加噪就行： $$ q(x{1:T}|x_0, z) \\approx q(x{1:T}|x_0) $$ 也就是说，加噪过程与 VAE 相关信息无关，依旧是传统的 DDPM 算法的扩散加噪，从原图像 $x_0$ 开始，每一步只是简单地注入噪声，潜在空间一点没用上。\n逆向过程的依赖性：\n逆向去噪过程中，扩散模型使用VAE 的重构结果 $\\hat{x}0$ 作为参考信息，而不是直接依赖潜在表示 $z$，即： $$ p(x{0:T}|z) \\approx p(x_{0:T}|\\hat{x}_0) $$ 在每个去噪步骤中，把 $ \\hat{x}_0 $ 与当前带噪声的图像 $ x_t $ 一并拼接后 $[,x_t,, \\hat{x}0,]$ 输入到扩散网络中，让网络预测噪声或直接预测 $x{t-1}$。$ \\hat{x}_0 $ 提供“目标图像应该长什么样”的参考，而 $ x_t $ 是当前带噪声的图像，网络学着如何将 $ x_t $ 去噪并向 $ \\hat{x}_0 $ 靠拢。\n第二种简化假设： 正向过程的依赖性：\n这里正向过程被设计为显式依赖于 VAE 重构结果 $\\hat{x}0$： $$ q(x{1:T}|x_0, z) \\approx q(x_{1:T}|\\hat{x}_0, x_0) $$ 这意味着在每一步加噪过程中，模型会直接结合 $x_0$ 和 $\\hat{x}_0$ 的信息，即把 $ \\hat{x}_0 $ 也作为输入条件，使加噪分布围绕着 $ \\hat{x}_0 $ 进行。\n逆向过程的依赖性：\n和第一种简化假设相同： $$ p(x_{0:T}|z) \\approx p(x_{0:T}|\\hat{x}_0) $$\n正向过程的具体设计\n在第二种假设中，主要针对了正向过程中的输入条件，把 VAE 重构结果 $\\hat{x}_0$ 也包含在加噪过程中，我们先和标准的DDPM比较一下:\n在标准 DDPM 中：如果不断加大噪声，到达 $x_T$ 时，理想情况下 $x_T$ 就分布于一个各向同性的高斯噪声 $\\mathcal{N}(0, \\mathbf{I})$\n在第二种假设中: 当 $t \\to T$ 且噪声足够大时，$q(x_T \\mid x_0, \\hat{x}_0) \\approx \\mathcal{N}\\bigl(\\hat{x}_0, \\mathbf{I}\\bigr) $ ，我们先给出结论，后续给出推导过程\n也就是说，最终的 带噪样本分布是围绕 $ \\hat{x}_0 $ 的一个近似单位方差的高斯，而不是围绕 0，成为了加噪和去噪的中心参考点。这样有一个好处，样本都时刻记得有一个 $ \\hat{x}_0 $ 作为 目标中心，因而在逆向还原时更容易保持与 $ \\hat{x}_0 $ 的结构或风格一致。\n但是实际上没有这么高深，其想法很简单，DDPM 算法中输入 A 输出也是 A，在 DiffuseVAE 中输入 VAE 重构结果 $\\hat{x}_0$ 输出肯定也得是 $\\hat{x}_0$ ，然后给出标准答案（原图）$x_0$ 作为参考。\n正向过程详细数学推导\n假设对正向过程每一步都采用变分推断中常用的高斯分布假设： $$ q(x_t|x_{t-1}, \\hat{x}0) = \\mathcal{N}(\\sqrt{1-\\beta_t}x{t-1} + (1-\\sqrt{1-\\beta_t})\\hat{x}_0, \\beta_t \\mathbf{I}) $$\n从 $x_{t-1}$ 到 $x_t$ 会注入高斯噪声，方差为 $\\beta_t \\mathbf{I}$ 均值项中不仅有 $\\sqrt{1-\\beta_t},x_{t-1}$，还额外加上 $(1 - \\sqrt{1-\\beta_t}),\\hat{x}_0$ 若 $\\beta_t$ 很小，则 $\\sqrt{1-\\beta_t} \\approx 1$，此时均值主要受 $x_{t-1}$ 控制，$ \\hat{x}_0 $ 占的比重较小 随着 $\\beta_t$ 增大，每一步加噪时，$ \\hat{x}_0 $ 占的权重会逐渐明显，让 $x_t$ 更靠近 $ \\hat{x}_0 $ 在每个时间步中，$x_t$ 的生成不仅依赖于前一时间步 $x_{t-1}$，还结合了 $\\hat{x}_0$ 的全局信息，即 $x_t$ 由原始数据 $x_0$ 和 VAE 重构 $\\hat{x}_0$ 的加权和决定的。\n第一步 $t = 1$ 的加噪过程可以写为: $$ q(x_1|x_0, \\hat{x}_0) = \\mathcal{N}(\\sqrt{1-\\beta_1}x_0 + \\hat{x}_0, \\beta_1 \\mathbf{I}) $$ 这样把原图像 $x_0$ 的主要信息留下，同时把 $ \\hat{x}_0 $ 一次性地注入到分布里。\n正向条件边缘分布\n通过连续乘法展开，可得到该正向过程在第 $t$ 步时的边缘分布： $$ q(x_t \\mid x_0, \\hat{x}_0) = \\mathcal{N}\\Bigl(\\sqrt{\\bar{\\alpha}_t}, x_0 + \\hat{x}_0,;\\bigl(1-\\bar{\\alpha}_t\\bigr)\\mathbf{I}\\Bigr) $$ 其中 $$ \\bar{\\alpha}t = \\prod{i=1}^t (1 - \\beta_i) $$\n当 $t$ 逐渐增大，$\\bar{\\alpha}_t$ 会变得很小（因为 $(1 - \\beta_i)$ 都小于 1，相乘会衰减），于是 $\\sqrt{\\bar{\\alpha}_t} \\approx 0$。\n故当 $t$ 到达 $T$ 时，$\\bar{\\alpha}_T \\approx 0$，即可得到 $$ q(x_T \\mid x_0, \\hat{x}_0) \\approx \\mathcal{N}\\bigl(\\hat{x}_0, \\mathbf{I}\\bigr) $$\n实现 在不同潜在空间进行插值的差异 如前所述，DiffuseVAE 中包含两种潜在表示：\n低维潜在向量 $z_\\text{vae}$（来自第1阶段 VAE） 高维潜在表示 $x_{1:T}$（来自第2阶段 DDPM 逆向过程） 在实验中，我们分别在 $z_\\text{vae}$ 空间和 $x_T$ 空间（即 DDPM 逆向过程的初始分布采样空间）中进行插值，直观地对比了两种插值方式对合成结果所产生的影响。\n在 $z_\\text{vae}$ 空间进行插值\n插值公式\n$$ \\tilde{z}\\text{vae} ;=; \\lambda z\\text{vae}^{(1)} ;+; (1 - \\lambda),z_\\text{vae}^{(2)} \\quad 0 \u003c \\lambda \u003c 1 $$ 将插值得到的 $\\tilde{z}_\\text{vae}$ 输入到 DiffuseVAE 中，先通过 VAE 生成模糊初始图，再进入扩散DDPM细化过程，得到最终清晰结果。 在 $x_T$ 空间进行插值\n插值公式\n$$ \\tilde{x}_T ;=; \\lambda,x_T^{(1)} ;+; (1 - \\lambda),x_T^{(2)}\\quad 0 \u003c \\lambda \u003c 1 $$ 其中 $x_T^{(1)}$ 与 $x_T^{(2)}$ 是从 DDPM 的初始分布 $p(x_T)$ 中分别采样得到的高维表示（形状与图像相同）。随后，$\\tilde{x}_T$ 通过第2阶段逆向过程逐步去噪，生成最终图像。 $z_\\text{vae}$ 空间插值用于全局结构的控制，$x_T$ 空间插值则更多地用于细节层面的操作。\nDiffuseVAE 在采样速度与质量权衡中的表现 扩散模型（DDPM） 通常面临“采样步数”与“样本质量”之间的两难：\n采样步数越多（如 1000 步），生成样本质量往往越好，但速度更慢； 采样步数越少（如 10、25、50 步），采样速度更快，但生成质量低。 DiffuseVAE 在低采样步数时更优\n当 $T$ 从 10 到 100 时，DiffuseVAE 的 FID 分数始终优于无条件 DDPM，特别是在 $T=25$ 和 $T=50$ 时优势明显。 无条件 DDPM 在极高步数（$T=1000$）时更优\n当将采样步数提升到训练时常用的 1000 步，纯 DDPM 的最终 FID 略好于 DiffuseVAE。 论文中推测原因在于 VAE 的先验空洞问题（prior-hole problem）：VAE 的先验分布 $p(z)$ 与后验 $q(z)$ 不匹配，部分潜在区域对应的样本质量太差，DDPM 对这些样本的细化也无能为力，从而整体 FID 拉低。 通过后拟合（Ex-PDE 等）可显著改善\n若在训练后，对 VAE 潜在编码分布用更灵活的模型（如高斯混合模型 GMM）进行拟合并从中采样，可以缓解先验空洞问题。结果表示在 $T=1000$ 步时其结果大幅改善 与最先进模型的比较 在 CIFAR-10 上\n接下来我们直接以成绩说话。\nVAE Baseline ：FID 139.50，IS 3.23。单纯的VAE是当之无愧的垫底。\nDiffuseVAE : FID 在 2.62 - 2.95 之间，IS 大约在 9.5 - 9.7 之间，比单纯的 DDPM 效果好一些。在众多算法中排前列，但是我认为这是DDPM的功劳。\n在 CelebA-64x基准上\n我们可见 DIffuseVAE 并没有优于 DDPM，这是不应该的。\n在 CelebA-256x基准上\n还行，主要是靠的 DDPM。\n主要是DDPM的功劳\n",
  "wordCount" : "9530",
  "inLanguage": "zh",
  "image": "http://zehua.eu/images/papermod-cover.png","datePublished": "2024-11-27T16:25:17+01:00",
  "dateModified": "2024-11-27T17:12:35+08:00",
  "author":{
    "@type": "Person",
    "name": "zehua"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://zehua.eu/zh/posts/machinelearning_cn/diffusevae%E7%BD%91%E7%AB%99%E7%89%88/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "主页",
    "logo": {
      "@type": "ImageObject",
      "url": "http://zehua.eu/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://zehua.eu/zh/" accesskey="h" title="主页 (Alt + H)">主页</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://zehua.eu/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://zehua.eu/zh/posts/" title="列表">
                    <span>列表</span>
                </a>
            </li>
            <li>
                <a href="http://zehua.eu/zh/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://zehua.eu/zh/archives/" title="时间轴">
                    <span>时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://zehua.eu/zh/about/" title="版权说明">
                    <span>版权说明</span>
                </a>
            </li>
            <li>
                <a href="http://zehua.eu/zh/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://zehua.eu/zh/">主页</a>&nbsp;»&nbsp;<a href="http://zehua.eu/zh/posts/">Posts</a>&nbsp;»&nbsp;<a href="http://zehua.eu/zh/posts/machinelearning_cn/">机器学习</a></div>
    <h1 class="post-title entry-hint-parent">
      论文阅读 - DiffuseVAE 详解
    </h1>
    <div class="post-meta">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/v4-shims.css"><span class="meta-tag"><span class="fa fa-calendar-plus-o"></span>&nbsp;<span title='2024-11-27 16:25:17 +0100 CET'>11月27日, 2024</span></span>&nbsp; | &nbsp;<span class="meta-tag"><span class="fa fa-file-word-o"></span>&nbsp;<span>共9530字</span></span>&nbsp; | &nbsp;<span class="meta-tag"><span class="fa fa-user-circle-o"></span>&nbsp;<span>zehua</span></span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#diffusevae" aria-label="DiffuseVAE">DiffuseVAE</a><ul>
                            
                    <li>
                        <a href="#%e8%83%8c%e6%99%af%e9%97%ae%e9%a2%98" aria-label="背景问题："><strong>背景问题</strong>：</a></li>
                    <li>
                        <a href="#vae%e5%92%8c%e6%89%a9%e6%95%a3%e6%a8%a1%e5%9e%8b%e7%9a%84%e4%bc%98%e7%bc%ba%e7%82%b9" aria-label="VAE和扩散模型的优缺点"><strong>VAE和扩散模型的优缺点</strong></a></li>
                    <li>
                        <a href="#vae%e5%92%8cddpm%e5%a4%8d%e4%b9%a0%e5%9b%9e%e9%a1%be" aria-label="VAE和DDPM复习回顾"><strong>VAE和DDPM复习回顾</strong></a><ul>
                            
                    <li>
                        <a href="#%e5%8f%98%e5%88%86%e8%87%aa%e7%bc%96%e7%a0%81%e5%99%a8-vae-" aria-label="变分自编码器 (VAE )"><strong>变分自编码器 (VAE )</strong></a></li>
                    <li>
                        <a href="#ddpm" aria-label="DDPM"><strong>DDPM</strong></a><ul>
                            
                    <li>
                        <a href="#%e6%ad%a3%e5%90%91%e5%8a%a0%e5%99%aa%e8%bf%87%e7%a8%8b" aria-label="正向加噪过程"><strong>正向加噪过程</strong></a></li>
                    <li>
                        <a href="#%e9%80%86%e5%90%91%e5%8e%bb%e5%99%aa%e8%bf%87%e7%a8%8b" aria-label="逆向去噪过程"><strong>逆向去噪过程</strong></a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#diffusevae-vae%e4%b8%8e%e6%89%a9%e6%95%a3%e6%a8%a1%e5%9e%8b%e7%9a%84%e7%bb%93%e5%90%88" aria-label="DiffuseVAE: VAE与扩散模型的结合"><strong>DiffuseVAE: VAE与扩散模型的结合</strong></a><ul>
                            
                    <li>
                        <a href="#%e7%ae%97%e6%b3%95%e6%a1%86%e6%9e%b6" aria-label="算法框架："><strong>算法框架</strong>：</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%95%b0%e5%ad%a6%e7%90%86%e8%ae%ba" aria-label="数学理论">数学理论</a><ul>
                            
                    <li>
                        <a href="#%e5%85%83%e7%b4%a0%e8%a1%a8%e8%be%be" aria-label="元素表达">元素表达</a></li>
                    <li>
                        <a href="#%e8%81%94%e5%90%88%e5%88%86%e5%b8%83%e7%9a%84%e5%88%86%e8%a7%a3" aria-label="联合分布的分解">联合分布的分解</a></li>
                    <li>
                        <a href="#%e5%90%8e%e9%aa%8c%e5%88%86%e5%b8%83%e7%9a%84%e8%bf%91%e4%bc%bc" aria-label="后验分布的近似">后验分布的近似</a></li>
                    <li>
                        <a href="#%e6%95%b0%e6%8d%ae%e5%af%b9%e6%95%b0%e4%bc%bc%e7%84%b6" aria-label="数据对数似然">数据对数似然</a></li>
                    <li>
                        <a href="#%e8%af%81%e6%8d%ae%e4%b8%8b%e7%95%8celbo" aria-label="证据下界（ELBO）">证据下界（ELBO）</a></li>
                    <li>
                        <a href="#%e7%ae%80%e5%8c%96%e8%ae%be%e8%ae%a1" aria-label="简化设计">简化设计</a><ul>
                            
                    <li>
                        <a href="#%e6%9d%a1%e4%bb%b6%e4%bf%a1%e5%8f%b7-y-%e7%9a%84%e7%ae%80%e5%8c%96" aria-label="条件信号 $y$ 的简化">条件信号 $y$ 的简化</a></li>
                    <li>
                        <a href="#%e6%bd%9c%e5%9c%a8%e8%a1%a8%e7%a4%ba-z-%e7%9a%84%e7%ae%80%e5%8c%96" aria-label="潜在表示 $z$ 的简化">潜在表示 $z$ 的简化</a></li>
                    <li>
                        <a href="#%e4%b8%a4%e9%98%b6%e6%ae%b5%e7%8b%ac%e7%ab%8b%e8%ae%ad%e7%bb%83%e7%9a%84%e7%ae%80%e5%8c%96" aria-label="两阶段独立训练的简化">两阶段独立训练的简化</a></li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93%e4%b8%80%e4%b8%8b%e8%bf%99%e4%b8%89%e7%82%b9%e7%ae%80%e5%8c%96" aria-label="总结一下这三点简化">总结一下这三点简化</a></li></ul>
                    </li>
                    <li>
                        <a href="#vae-%e5%8f%82%e6%95%b0%e5%8c%96%e7%9a%84%e9%80%89%e6%8b%a9" aria-label="VAE 参数化的选择">VAE 参数化的选择</a></li>
                    <li>
                        <a href="#ddpm%e6%89%a9%e6%95%a3%e6%a8%a1%e5%9e%8b%e4%b8%a4%e7%a7%8d%e8%ae%be%e8%ae%a1%e5%81%87%e8%ae%be" aria-label="DDPM扩散模型两种设计假设">DDPM扩散模型两种设计假设</a><ul>
                            
                    <li>
                        <a href="#%e7%ac%ac%e4%b8%80%e7%a7%8d%e7%ae%80%e5%8c%96%e5%81%87%e8%ae%be" aria-label="第一种简化假设：">第一种简化假设：</a></li>
                    <li>
                        <a href="#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e7%ae%80%e5%8c%96%e5%81%87%e8%ae%be" aria-label="第二种简化假设：">第二种简化假设：</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0" aria-label="实现">实现</a><ul>
                            
                    <li>
                        <a href="#%e5%9c%a8%e4%b8%8d%e5%90%8c%e6%bd%9c%e5%9c%a8%e7%a9%ba%e9%97%b4%e8%bf%9b%e8%a1%8c%e6%8f%92%e5%80%bc%e7%9a%84%e5%b7%ae%e5%bc%82" aria-label="在不同潜在空间进行插值的差异">在不同潜在空间进行插值的差异</a></li></ul>
                    </li>
                    <li>
                        <a href="#diffusevae-%e5%9c%a8%e9%87%87%e6%a0%b7%e9%80%9f%e5%ba%a6%e4%b8%8e%e8%b4%a8%e9%87%8f%e6%9d%83%e8%a1%a1%e4%b8%ad%e7%9a%84%e8%a1%a8%e7%8e%b0" aria-label="DiffuseVAE 在采样速度与质量权衡中的表现">DiffuseVAE 在采样速度与质量权衡中的表现</a></li>
                    <li>
                        <a href="#%e4%b8%8e%e6%9c%80%e5%85%88%e8%bf%9b%e6%a8%a1%e5%9e%8b%e7%9a%84%e6%af%94%e8%be%83" aria-label="与最先进模型的比较">与最先进模型的比较</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h1 id="diffusevae">DiffuseVAE<a hidden class="anchor" aria-hidden="true" href="#diffusevae">#</a></h1>
<h2 id="背景问题"><strong>背景问题</strong>：<a hidden class="anchor" aria-hidden="true" href="#背景问题">#</a></h2>
<ul>
<li><strong>扩散模型</strong>：生成质量高，但存在两个缺点：① 缺乏低维、可解释的潜在空间；② 生成速度较慢。</li>
<li><strong>VAE</strong>：具有低维潜在空间，可以解释和操控生成，但生成图像质量较差。</li>
</ul>
<p>因此提出了 <strong>DiffuseVAE</strong>，将VAE嵌入到扩散模型框架中，并设计了新的条件参数化方法，使扩散模型能够利用VAE推导的低维潜在编码。在标准基准（如 CIFAR-10 和 CelebA-64）上，生成质量优于大多数基于 VAE 的方法，并与最先进模型接近，并独特地保留了对低维潜在空间的访问能力，这是其他模型没有的。</p>
<h2 id="vae和扩散模型的优缺点"><strong>VAE和扩散模型的优缺点</strong><a hidden class="anchor" aria-hidden="true" href="#vae和扩散模型的优缺点">#</a></h2>
<ul>
<li>
<p><strong>VAE 的特点</strong>：</p>
<ul>
<li><strong>显式似然生成模型</strong>：以概率分布的方式描述数据生成过程。</li>
<li><strong>低维潜在表示</strong>：通过学习隐空间表示，可以捕捉数据的结构和特征。</li>
<li><strong>灵活性</strong>：适用于多种任务，包括：
<ul>
<li>解耦表示学习（分离数据中的不同特征）。</li>
<li>半监督学习（结合少量有标注数据进行学习）。</li>
<li>异常检测（识别偏离正常分布的样本）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>VAE 的局限性</strong>：</p>
<ul>
<li><strong>模糊的生成样本</strong>：生成图像往往缺乏高频细节和清晰度。</li>
<li><strong>结构复杂性</strong>：最近的一些改进（如层次化潜在结构）尽管提高了生成质量，但增加了模型复杂度（需要大规模的潜在代码层次化结构）。</li>
<li><strong>与GAN的差距</strong>：相比隐式生成模型（如GAN），VAE在样本质量上仍显逊色，特别是在视觉感知方面。</li>
</ul>
</li>
<li>
<p><strong>扩散模型（DDPM）的优势和局限性</strong>：</p>
<ul>
<li><strong>生成质量高</strong>：在多个图像合成任务中表现优异，甚至在某些基准上超越了GANs。</li>
<li><strong>高昂的计算成本</strong>：生成样本时需要多次迭代的逐步采样过程，计算开销大，生成速度慢。</li>
<li><strong>缺乏低维潜在表示</strong>：无法像VAE那样学习和利用低维潜在空间，这限制了其在某些下游任务（如表示解耦、异常检测、可控生成）中的应用。</li>
</ul>
</li>
</ul>
<h2 id="vae和ddpm复习回顾"><strong>VAE和DDPM复习回顾</strong><a hidden class="anchor" aria-hidden="true" href="#vae和ddpm复习回顾">#</a></h2>
<h3 id="变分自编码器-vae-"><strong>变分自编码器 (VAE )</strong><a hidden class="anchor" aria-hidden="true" href="#变分自编码器-vae-">#</a></h3>
<p>VAE  是一种利用深度神经网络进行变分推断的生成模型，使用编码器将数据 $x$ 映射到潜在空间表示 $z$，再通过解码器从 $z$ 重建 $x$。它通过最大化数据对数似然 $\log p(x)$ 来学习模型，但由于直接计算对数似然通常不可行，VAE 使用 <strong>证据下界（ELBO）</strong> 来近似优化。</p>
<p>VAE 的损失函数（ELBO）定义如下：
$$
\mathcal{L}(\theta, \phi) = \underbrace{\mathbb{E}<em>{q</em>\phi(z|x)}[\log p_\theta(x|z)]}<em>{\text{重建误差}} - \underbrace{D</em>{KL}[q_\phi(z|x) | p(z)]}_{\text{KL 散度正则化}}
$$
为了使模型的优化过程可微分，VAE 引入了重参数化技巧，将采样过程从随机变量 $z$ 中分离。例如，将随机变量 $z$ 表示为 $z = \mu + \sigma \cdot \epsilon$，其中 $\epsilon$ 是从标准正态分布采样的噪声。默认先验分布 $p(z)$ 通常设为标准高斯分布，但可以扩展到更复杂的分布（如混合分布或归一化流）以提升模型的表达能力。</p>
<p>更详细内容请看 <a href="https://zehua.eu/zh/posts/machinelearning_cn/vae/">VAE</a></p>
<h3 id="ddpm"><strong>DDPM</strong><a hidden class="anchor" aria-hidden="true" href="#ddpm">#</a></h3>
<p>DDPM 是一种基于潜变量的生成模型， 利用正向过程将数据逐步加噪到高斯分布，再通过逆向过程从噪声中逐步还原数据。包含两个过程：</p>
<h4 id="正向加噪过程"><strong>正向加噪过程</strong><a hidden class="anchor" aria-hidden="true" href="#正向加噪过程">#</a></h4>
<p>通过一个固定的高斯马尔可夫链，逐步对数据 $x_0$ 加噪，使其最终接近各向同性高斯分布。正向过程的核心是逐步破坏数据结构，每一步的加噪过程使用高斯分布：
$$
q(x_{1:T}|x_0) = \prod_{t=1}^{T} q(x_t|x_{t-1})
$$
这意味着当前状态 $x_t$ 仅依赖于前一个状态 $x_{t-1}$，整个加噪过程的联合分布可以通过各步的条件分布相乘得到，每一步的加噪过程由高斯分布建模：
$$
q(x_t|x_{t-1}) = \mathcal{N}(\sqrt{1-\beta_t}x_{t-1}, \beta_t\mathbf{I})
$$</p>
<ul>
<li>其中 $\beta_t$ 是噪声调度参数，决定每一步加噪的程度。</li>
</ul>
<p>通过数学推导，可以从原始数据 $x_0$ 直接生成第 $t$ 步数据：
$$
q(x_t|x_0) = \mathcal{N}(\sqrt{\bar{\alpha}_t}x_0, (1-\bar{\alpha}_t)\mathbf{I})
$$</p>
<ul>
<li>其中 $\bar{\alpha}<em>t = \prod</em>{i=1}^t (1-\beta_i)$ 是累积衰减系数。</li>
</ul>
<p>正向过程是固定的，不需要学习，最终会将数据 $x_0$ 转化为接近高斯分布的 $x_T$。</p>
<h4 id="逆向去噪过程"><strong>逆向去噪过程</strong><a hidden class="anchor" aria-hidden="true" href="#逆向去噪过程">#</a></h4>
<p>逆向过程试图逐步还原数据，采用可学习的高斯马尔可夫链：
$$
p_\theta(x_{t-1}|x_t) = \mathcal{N}(\mu_\theta(x_t, t), \Sigma_\theta(x_t, t))
$$</p>
<ul>
<li>其中均值 $\mu_\theta$ 和协方差 $\Sigma_\theta$ 是通过神经网络学习的。</li>
</ul>
<p>采样时，先从 $p(x_T)$（通常选为各向同性高斯分布）中采样一个噪声向量，再运行逆向过程逐步去噪，生成最终样本 $x_0$。</p>
<p>噪声调度参数 $\beta_t$ 是正向加噪过程的核心，影响生成样本的质量和采样速度。可以是固定值，也可以通过优化学习得到。整个模型通过变分推断优化，目标是最小化正向过程和逆向过程的分布差异。</p>
<p>DDPM 主要优势是生成样本质量高，但缺点是采样速度较慢（需要多次迭代）。这是许多扩散模型后续改进的基础，例如提高采样效率的 DDIM。</p>
<h2 id="diffusevae-vae与扩散模型的结合"><strong>DiffuseVAE: VAE与扩散模型的结合</strong><a hidden class="anchor" aria-hidden="true" href="#diffusevae-vae与扩散模型的结合">#</a></h2>
<p>提出的 <strong>DiffuseVAE</strong> 将 VAE 和 DDPM 结合，使生成过程既拥有 VAE 提供的低维潜在空间，又有 DDPM 生成高质量细节的能力。框架中通过两阶段建模，先利用 VAE 的低维潜在空间对样本进行全局特征建模生成粗略样本，再用 DDPM 细化提高质量。通过两阶段建模解决了 VAE 样本模糊和 DDPM 缺乏低维表示的问题。</p>
<h3 id="算法框架"><strong>算法框架</strong>：<a hidden class="anchor" aria-hidden="true" href="#算法框架">#</a></h3>
<ul>
<li>
<p>该框架可归纳为生成器-细化器框架</p>
<ul>
<li><strong>生成器</strong>：第一阶段通过VAE  对训练数据 $x$ 拟合，生成重构样本 $\hat{x}$。</li>
<li><strong>细化器</strong>：第二阶段通过条件 DDPM 对 VAE 的重构样本 $\hat{x}$ 进行细化建模，从而生成更高质量的样本。</li>
</ul>
</li>
<li>
<p>**第一阶段 **：VAE 建模</p>
<p>给定训练数据 $(x_0, y)$，其中 $x_0$ 是高分辨率数据（例如图像），$y$ 是辅助条件信号（例如一些特征描述信息）。</p>
<ul>
<li><strong>编码器</strong>：从 $(x_0, y)$ 中提取潜在表示 $z$，即 $q_\psi(z|y, x_0)$。这是一种条件后验分布，因为在给定 $(y,x_0)$ 的条件下，我们对 $z$ 的分布进行估计。</li>
<li><strong>解码器</strong>：在给定 $z$ 的前提下生成 $y$，即 $p_\theta(y|z)$。这里 $y$ 是由潜在表示 $z$ 解码而来的。</li>
</ul>
<p>注意，这里 VAE 最后的输出不是直接生成 $x_0$ ，而是生成 条件辅助信号 $y$ ，随后我们会在第二阶段使用扩散模型来从 $y$ 和 $z$ 再还原出 $x_0$ ，即生成 $x_0$ 是扩散模型DDPM算法的任务。形象一点来讲，VAE 的作用是给DDPM提供一个充满了信息（潜在特征）的藏宝图（低维潜在空间），真正一步步（逐渐加噪去噪）找到宝藏（恢复图片）还是要靠DDPM算法来实现</p>
</li>
<li>
<p><strong>第二阶段：DDPM 建模</strong></p>
<p>在有了 VAE 产生的条件信号 $y$ 以及对应的潜在表示 $z$ 后，我们利用条件扩散模型（DDPM）从 $y,z$ 出发，对 $x_0$ 进行细化生成。</p>
<p>这里和单纯扩散模型DDPM算法过程类似，依旧是加噪和去噪过程</p>
<ul>
<li>
<p><strong>前向加噪过程</strong>：</p>
<p>从真实数据 $x_0$ 开始，不断向其添加噪声，经过 $T$ 步得到一系列加噪样本 $x_{1:T}$。这一过程用 $q(x_{1:T}|y,z,x_0)$ 表示，该分布是已知的（通常是固定高斯加噪过程）。</p>
</li>
<li>
<p><strong>逆向去噪过程</strong>：</p>
<p>扩散模型要学习从纯噪声逐步去噪回到 $x_0$ 的逆向分布 $p_\phi(x_{0:T}|y,z)$。这里 $p_\phi$ 由参数 $\phi$ 决定，需要通过训练来拟合。在条件 $y$ 和潜在表示 $z$ 下逐步还原出 $x_0$。</p>
</li>
</ul>
</li>
</ul>
<p>这里需要从真实数据 $x_0$ 开始加噪，然后得到 $x_{1:T}$ ，这里从真实数据开始而不是直接从  $y,z$ 开始的原因是；真实数据提供了逆向去噪的正确答案，即当我们用真实数据加噪后，逆向去噪应该能从 $x_T$ 最终得到原始的 $x_0$，那么就说明去噪过程是正确的。</p>
<p>![image-20241211100919496](/Users/zehua/Library/Application Support/typora-user-images/image-20241211100919496.png)</p>
<p>DiffuseVAE 的低维潜在空间能够捕捉生成样本的全局特征(内容、形状或结构)，这就意味着用户可以通过修改这个潜在空间中的变量来直接影响生成样本的主要特性。并且 DiffuseVAE 在速度和质量之间取得了更好的平衡。例如，仅需 10 步采样就能生成质量合理的样本，比传统 DDPM 的效率更高，且生成效果优于相同采样次数的其他方法（如 DDIM）。DiffuseVAE 经过预训练后，对条件信号中的不同噪声类型表现出较好的泛化能力，证明其框架不仅适合特定场景，还能应对多种不确定性条件。</p>
<h2 id="数学理论">数学理论<a hidden class="anchor" aria-hidden="true" href="#数学理论">#</a></h2>
<h3 id="元素表达">元素表达<a hidden class="anchor" aria-hidden="true" href="#元素表达">#</a></h3>
<ul>
<li>$x_0$：我们想生成的高分辨率图像；</li>
<li>$y$：通过 VAE 建模的辅助条件信号；</li>
<li>$z$：与 $y$ 相关联的潜在表示；</li>
<li>$x_{1:T}$：扩散模型学习到的 $T$ 个加噪表示。</li>
<li>$\hat{x}_0$ : VAE 的重构图像</li>
</ul>
<h3 id="联合分布的分解">联合分布的分解<a hidden class="anchor" aria-hidden="true" href="#联合分布的分解">#</a></h3>
<p>$$
p(x_{0:T}, y, z) = p(z)p_\theta(y|z)p_\phi(x_{0:T}|y, z)
$$</p>
<ul>
<li>
<p><strong>$p(z)$</strong> 是潜在变量的先验分布，通常设为标准高斯分布；</p>
</li>
<li>
<p><strong>$p_\theta(y|z)$</strong> 表示在潜在变量 $z$ 下生成条件信号 $y$ 的概率，这是由 VAE 的解码器学习到的；</p>
</li>
<li>
<p><strong>$p_\phi(x_{0:T}|y, z)$</strong> 是扩散模型的逆向去噪过程，用来从条件信号 $y$ 和潜在表示 $z$ 逐步恢复数据。</p>
</li>
</ul>
<h3 id="后验分布的近似">后验分布的近似<a hidden class="anchor" aria-hidden="true" href="#后验分布的近似">#</a></h3>
<p>在给定数据 $(x_0, y)$ 的情况下，潜在表示 $z$ 和中间加噪样本 $x_{1:T}$ 的后验分布：
$$
p(x_{1:T}, z|y, x_0)
$$
该后验分布没有显式解析解，于是我们用一个近似分布 $q(x_{1:T}, z|y, x_0)$ 来替代：
$$
q(x_{1:T}, z|y, x_0) = q_\psi(z|y, x_0)q(x_{1:T}|y, z, x_0)
$$</p>
<p>这里的近似分布由两部分构成：</p>
<ul>
<li>
<p>$q_\psi(z|y, x_0)$ 是 VAE 的识别网络，它负责从 $y$ 和 $x_0$ 中推断潜在变量 $z$</p>
</li>
<li>
<p>$q(x_{1:T}|y, z, x_0)$ 是扩散模型的前向加噪过程，从 $x_0$ 开始加噪到 $x_{1:T}$。这个分布是已知且不需要参数化，因为前向过程是人为设定的加噪机制。</p>
</li>
</ul>
<p>因此我们将复杂的后验分布分解成了两部分：一部分是 VAE 的后验（学习 $z$），另一部分是一个确定的加噪过程（生成 $x_{1:T}$）</p>
<h3 id="数据对数似然">数据对数似然<a hidden class="anchor" aria-hidden="true" href="#数据对数似然">#</a></h3>
<p>我们的最终目标是最大化数据 $(x_0, y)$ 的对数似然 $\log p(x_0, y)$：
$$
\log p(x_0, y) = \log \int p(x_{0:T}, y, z) dx_{1:T} dz
$$
这表示，我们需要对联合分布 $p(x_{0:T}, y, z)$ 进行积分，边缘化掉 $x_{1:T}$ 和 $z$。但是，和 VAE 情况类似，在实际中非常困难计算，为此，我们引入了 <strong>证据下界(ELBO)</strong> 来对 $\log p(x_0, y)$ 进行下界估计，以便通过优化 ELBO 来最大化 $\log p(x_0, y)$。</p>
<h3 id="证据下界elbo">证据下界（ELBO）<a hidden class="anchor" aria-hidden="true" href="#证据下界elbo">#</a></h3>
<p>ELBO 的定义是：
$$
\begin{aligned}
\log p(x_0, y) \geq &amp; \underbrace{\mathbb{E}<em>{q</em>\psi(z|y,x_0)} \big[ p_\theta(y|z) \big] - \mathcal{D}<em>{KL} \big(q</em>\psi(z|y,x_0) | p(z)\big)}<em>{\mathcal{L}</em>{\text{VAE}}}</p>
<ul>
<li>\mathbb{E}<em>{z \sim q(z|y,x_0)} \left[\underbrace{ \mathbb{E}</em>{q(x_{1:T}|y,z,x_0)} \left[ \frac{p_\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)} \right] }<em>{\mathcal{L}</em>{\text{DDPM}}}\right]
\end{aligned}
$$</li>
</ul>
<div
    class="alert alert-warning"    role="alert"><text><p><strong>证明</strong></p>
<p>我们希望最大化数据 $(x_0,y)$ 的对数似然：
$$
\log p(x_0,y) = \log \int p(x_{0:T}, y, z) ,dx_{1:T},dz
$$</p>
<p>这里 $x_{1:T}$ 和 $z$ 是潜在变量（未观测量），直接求解该对数似然通常非常困难。</p>
<p><strong>步骤1：引入近似分布</strong></p>
<p>为了对上述不可直接计算的积分进行处理，我们引入两个近似后验分布：</p>
<ul>
<li>$q_\psi(z|y,x_0)$：用于逼近真实后验 $p(z|x_0,y)$</li>
<li>$q(x_{1:T}|y,z,x_0)$：用于逼近真实加噪过程的后验（在此情况中，它往往是定义好的正向加噪过程，而非需近似的；这里更多是从数学形式上刻画）。</li>
</ul>
<p>有了这两个分布，我们可在对数似然中乘以1的巧妙形式：
$$
1 = \frac{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}
$$</p>
<p>将此代入后得到：
$$
\log p(x_0,y) = \log \int p(x_{0:T}, y, z) \frac{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)} ,dx_{1:T},dz
$$</p>
<p><strong>步骤2：期望形式表示</strong></p>
<p>将积分形式转换为期望的概率表示：
$$
\log p(x_0,y) = \log \mathbb{E}<em>{q</em>\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\left[ \frac{p(x_{0:T}, y, z)}{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)} \right]
$$</p>
<p>现在我们有期望的结构，可以使用 Jensen’s inequality（詹森不等式）对对数的期望下界化。</p>
<p><strong>步骤3：应用 Jensen’s inequality 获得ELBO下界</strong></p>
<p>对于任意随机变量 $X$ 和凹函数 $\log(\cdot)$，詹森不等式有：
$$
\log \mathbb{E}[X] \geq \mathbb{E}[\log X]
$$</p>
<p>将其应用于上式：
$$
\log p(x_0,y) \geq \mathbb{E}<em>{q</em>\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\left[\log \frac{p(x_{0:T}, y, z)}{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\right]
$$</p>
<p>这就得到了所谓的ELBO（下界）。</p>
<p><strong>步骤4：分解联合分布 $p(x_{0:T}, y, z)$</strong></p>
<p>对联合分布使用给定模型的分解方式：
$$
p(x_{0:T}, y, z) = p(z)p_\theta(y|z)p_\phi(x_{0:T}|y,z)
$$</p>
<p>代入后：
$$
\log p(x_0,y) \geq \mathbb{E}<em>{q</em>\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\left[\log \frac{p(z)p_\theta(y|z)p_\phi(x_{0:T}|y,z)}{q_\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\right]
$$</p>
<p>将对数展开为加法：
$$
=  \mathbb{E}<em>{q</em>\psi(z|y,x_0)q(x_{1:T}|y,z,x_0)}\left[\log p_\theta(y|z) + \log p_\phi(x_{0:T}|y,z) + \log p(z) - \log q_\psi(z|y,x_0) - \log q(x_{1:T}|y,z,x_0)\right]
$$</p>
<p>把联合期望写成双重期望的形式，我们得到:
$$
\log p(x_0,y) \geq \mathbb{E}<em>{q</em>\psi(z|y,x_0)}\mathbb{E}<em>{q(x</em>{1:T}|y,z,x_0)}[\log p_\theta(y|z) + \log p_\phi(x_{0:T}|y,z) + \log p(z) - \log q_\psi(z|y,x_0) - \log q(x_{1:T}|y,z,x_0)]
$$</p>
<p><strong>步骤5：分离VAE部分与DDPM部分</strong></p>
<p>观察上述期望，我们可将其分为两部分：</p>
<ol>
<li>
<p>仅与 $z$ 有关的项（VAE相关项）：
$$
\mathbb{E}<em>{q</em>\psi(z|y,x_0)}[\log p_\theta(y|z) + \log p(z) - \log q_\psi(z|y,x_0)]
$$</p>
<p>此处用标准的VAE推导可知，这部分是VAE的ELBO形式：</p>
<ul>
<li>$\log p_\theta(y|z)$ 是重建项</li>
<li>$-\log q_\psi(z|y,x_0)$ 与 $\log p(z)$ 组合后给出KL散度约束项（$-D_{KL}[q_\psi(z|y,x_0)||p(z)]$）</li>
</ul>
<p>整合后，这部分为：
$$
\mathcal{L}<em>{\text{VAE}} = \mathbb{E}</em>{q_\psi(z|y,x_0)}[\log p_\theta(y|z)] - D_{KL}[q_\psi(z|y,x_0) | p(z)]
$$</p>
</li>
<li>
<p>与扩散过程相关的项（DDPM相关项）：
$$
\mathbb{E}<em>{z \sim q</em>\psi(z|y,x_0)}\left[\mathbb{E}<em>{q(x</em>{1:T}|y,z,x_0)}[\log p_\phi(x_{0:T}|y,z) - \log q(x_{1:T}|y,z,x_0)]\right]
$$</p>
<p>注意到 $\log p_\phi(x_{0:T}|y,z) - \log q(x_{1:T}|y,z,x_0)$ 可以进一步写成对数比：
$$
\mathbb{E}<em>{q(x</em>{1:T}|y,z,x_0)}\left[\log \frac{p_\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)}\right]
$$</p>
<p>将此部分定义为扩散模型相关的ELBO项：
$$
\mathcal{L}<em>{\text{DDPM}} = \mathbb{E}</em>{q(x_{1:T}|y,z,x_0)}\left[\log \frac{p_\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)}\right]
$$</p>
</li>
</ol>
<p>因此，最终得到的ELBO表达式为：
$$
\log p(x_0,y) \geq \underbrace{\mathbb{E}<em>{q</em>\psi(z|y,x_0)}[\log p_\theta(y|z)] - D_{KL}[q_\psi(z|y,x_0) | p(z)]}<em>{\mathcal{L}</em>{\text{VAE}}}</p>
<ul>
<li>\mathbb{E}<em>{z \sim q</em>\psi(z|y,x_0)}\left[ \underbrace{\mathbb{E}<em>{q(x</em>{1:T}|y,z,x_0)}\left[\log \frac{p_\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)}\right]}<em>{\mathcal{L}</em>{\text{DDPM}}}\right]
$$</li>
</ul>
<p>证毕</p>
</text></div>

<p>上式可以分为两大部分：</p>
<ol>
<li><strong>VAE 部分 ($\mathcal{L}_{\text{VAE}}$)</strong>：</li>
</ol>
<p>$$
\mathcal{L}<em>{\text{VAE}} = \mathbb{E}</em>{q_\psi(z|y,x_0)} \big[ p_\theta(y|z) \big] - \mathcal{D}<em>{KL} \big(q</em>\psi(z|y,x_0) | p(z)\big)
$$</p>
<ul>
<li>这是标准的 VAE 损失项，包括一个重构项（期望条件下 $z$ 对 $y$ 的重构对数似然）以及 KL 散度项（约束 $q_\psi(z|y,x_0)$ 接近先验 $p(z)$）。</li>
<li>VAE 部分的优化确保了潜在空间 $z$ 有意义，同时能让解码器在给定 $z$ 的情况下生成合理的 $y$。</li>
</ul>
<ol start="2">
<li><strong>DDPM 部分 ($\mathcal{L}_{\text{DDPM}}$)</strong>：</li>
</ol>
<p>$$
\mathbb{E}<em>{z \sim q(z|y,x_0)} \left[\underbrace{ \mathbb{E}</em>{q(x_{1:T}|y,z,x_0)} \left[ \frac{p_\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)} \right] }<em>{\mathcal{L}</em>{\text{DDPM}}}\right]
$$</p>
<p>要理解这个公式，首先我们需要回顾 DDPM 的背景:</p>
<p>在 DiffuseVAE 的框架中，$x_{1:T}$ 是扩散模型引入的中间加噪步骤，也就是从 $x_0$ 不断加噪直到几乎变成高斯噪声的过程。这里有两个分布很重要：</p>
<p>​	(a)  <strong>正向加噪过程</strong> $q(x_{1:T}|y,z,x_0)$：</p>
<p>这个过程是已知且固定的（通常我们设计一个固定的加噪策略）。给定真实数据 $x_0$、潜在变量 $z$ 和条件信息 $y$，我们能确定如何一步步往数据里加噪得到 $x_{1:T}$。该分布不需要学习，因为加噪规则是人定义的。</p>
<p>​	(b)  <strong>逆向去噪过程</strong> $p_\phi(x_{0:T}|y,z)$：</p>
<p>这个过程是模型需要学习的，即从纯噪声（或高度加噪的 $x_T$）一步步“去噪”回 $x_0$ 的概率分布。该分布由参数 $\phi$ 控制，通过神经网络拟合。如果参数 $\phi$ 拟合的好，说明 $p_\phi$ 完美匹配了真正的逆向分布，那么说明可以从噪声逆推回真实数据 $x_0$</p>
<p>再重新看这个公式，它分为内层期望和外层期望两部分</p>
<ul>
<li>
<p><strong>内层期望</strong>：
$$
\mathbb{E}<em>{q(x</em>{1:T}|y,z,x_0)} \left[ \frac{p_\phi(x_{0:T}|y,z)}{q(x_{1:T}|y,z,x_0)} \right]
$$</p>
<ul>
<li>分子 $p_\phi(x_{0:T}|y,z)$：希望从噪声出发还原数据的模型分布。</li>
<li>分母 $q(x_{1:T}|y,z,x_0)$：这是数据真实加噪时的分布。</li>
</ul>
<p>如果他们两个的比值期望大，那么说明逆向过程越好（因为真实加噪过程和真实逆向过程是正好相反的，如果模拟逆向过程等于真实逆向过程，那么这个差值最大期望最大），相反，如果 $p_\phi$ 和 $q$ 不匹配，这个期望值就会偏小。换句话说，这个期望项在测量 $p_\phi$ 与 $q$ 的吻合程度</p>
</li>
<li>
<p><strong>外层期望</strong>：</p>
<p>在上面讨论的内层期望中，我们是固定 $z$ 来看问题。但是 $z$ 本身是由 $q_\psi(z|y,x_0)$ 给定的（VAE的后验分布）。我们希望无论 $z$ 如何变化，模型都能保证逆向过程 $p_\phi$ 与正向过程 $q$ 匹配。</p>
<p>因此我们对 $z$ 的分布再求一个期望，这样就可以确保扩散模型在整个潜在空间分布下（即对各种可能的全局特征）都能完成从噪声到 $x_0$ 的还原。这保证了模型的普适性，即对各类潜在表征都能有效地还原数据。</p>
</li>
</ul>
<p>综上所述，内层期望是在问：如果按照正向过程 $q$ 的方式对 $x_0$ 加了噪声，那么逆向过程 $p_\phi$ 能否以高概率还原这个加噪后的样本到原始数据 $x_0$？如果能，这个比值就高，期望就大。外层期望再考虑对所有可能的 $z$ 做平均，以确保无论潜在表征是什么，模型都能完成这个逆向还原。因此，通过优化这个期望，我们就能让 $p_\phi$ 更好地匹配 $q$ 的逆过程，从而在训练中“教会”扩散模型如何去噪回到 $x_0$。</p>
<p>最后，ELBO 即为两部分之和：</p>
<p>$$
\log p(x_0, y) \geq \mathcal{L}<em>{\text{VAE}} + \mathbb{E}</em>{z \sim q(z|y,x_0)}[\mathcal{L}_{\text{DDPM}}]
$$</p>
<p>这为联合训练提供了一个可优化的目标函数。</p>
<p>总的来说，DiffuseVAE 的训练目标通过联合分布、后验分布近似以及 ELBO 分解，将 VAE 和扩散模型的损失函数结合起来。这个设计不仅让模型能够生成高质量的样本，还利用了低维潜在空间，提升了生成的控制性和效率。训练过程中，VAE 负责潜在表示的学习，扩散模型负责生成过程的细节还原，两者相辅相成。</p>
<h3 id="简化设计">简化设计<a hidden class="anchor" aria-hidden="true" href="#简化设计">#</a></h3>
<h4 id="条件信号-y-的简化">条件信号 $y$ 的简化<a hidden class="anchor" aria-hidden="true" href="#条件信号-y-的简化">#</a></h4>
<p>在原始 DiffuseVAE 的设计中，$y$ 是一个与 $x_0$​ 有关但不完全等同的条件信号。这样做的目的是为扩散模型提供附加条件，从而在逆向去噪过程中能够利用这些信息对生成样本进行更精细的控制。然而，这种设计在实际实现中可能会变得复杂：</p>
<ul>
<li>模型需要在去噪的每个步骤处理 $(y,z)$ 的条件信息，这增加了运算和实现上的难度。</li>
<li>$y$ 的选取和设计也会影响最终模型的性能与适用性，开发者需要思考如何选择合适的 $y$。</li>
</ul>
<p>因此做了一个重要简化，<strong>假设 $y = x_0$</strong>，也就是说，条件信号直接等于目标图像本身。我们简单来解释他，我们最开始的假想是在去噪的过程中额外输入一个与 $x_0$ 有关但不同的 $y$ 作为去噪的补充信息，比如说，VAE 生成了一个图像，模模糊糊的，我们现在告诉他，你要生成的应该是一只猫，现在我们做了这个简化，相当于去掉了补充信息，而直接将原图像作为补充信息，换句话说，直接给去噪过程标准答案，告诉他，你应该生成的就是这个猫图像类似的新图像。相当于压根就没有什么 $y$ ，研究到最后发现 $y$ 这个创新点没用，但是提都提了，就这么草率的把输入图像作为补充信息了。其实本质上就是用了两次输入图像，一份用来给 VAE 提取特征，一份给DDPM 作为参考答案</p>
<h4 id="潜在表示-z-的简化">潜在表示 $z$ 的简化<a hidden class="anchor" aria-hidden="true" href="#潜在表示-z-的简化">#</a></h4>
<p>潜在表示$z$ 是由 VAE 编码器从 $(x_0)$ 中获得的潜在表示。在原本的框架中，扩散模型可能需要同时考虑 $(y,z)$ 的条件输入，这意味着扩散模型输入要依赖潜在空间的表达，但是把一个潜在空间作为输入怎么做？没法做! 这就是为什么对潜在空间 $z$ 进行了简化。</p>
<p>简化思路是：既然 $z$ 是从 $x_0$ 映射得到的，那么 VAE 的解码器在给定 $z$ 时生成的 $\hat{x}_0$ 已经是 $z$ 的一个确定性函数。也就是说，$\hat{x}_0$ 完整地代表了 $z$ 中包含的信息。这就使得扩散模型可以直接使用 $\hat{x}_0$ 作为条件参考，而无需显式地输入 $z$。</p>
<p>我们还是简单的来解释他，其实思路是非常漂亮的，通过 VAE 得到输入，再传给 Diffusion 相当于引入了潜在空间，让 diffusion 充分利用潜在空间，完美的符合了DiffuseVAe 的思想，但是实际实现不出来，因为潜在空间不不是一个显式的数据集，是一个难啃的生数据，我们在 Diffusion 中用不了它，要想用，还是得在 VAE 中把 $z$ 转换成 $\hat{x}_0$ ，这样扩散模型接收的依旧是“图像形式”的条件，而不是抽象的潜在矢量。本质上是什么，本质上就是把 VAE 得到的结果输入给 DDPM 就是这么简单，DDPM中根本就没用潜在空间。</p>
<h4 id="两阶段独立训练的简化">两阶段独立训练的简化<a hidden class="anchor" aria-hidden="true" href="#两阶段独立训练的简化">#</a></h4>
<p>原本的想法是联合训练 VAE 部分（负责 $z$ 的学习和 $y$ 的重构）以及扩散部分（负责对重构样本做细化），这样可以在理论上实现一个端到端训练：模型同时学会提取潜在表示和利用扩散模型从潜在表示中生成高质量图像。但是! 联合训练在实际实现中非常复杂，参数多，计算量大，互为条件环路，即VAE 的输出是扩散模型的输入，扩散模型的性能又影响 VAE 的参数搜索空间，非常容易导致训练不稳定</p>
<p>为了简化训练过程，我们采用了顺序的两阶段训练方法：</p>
<ol>
<li>第一阶段只训练 VAE，学会从 $x_0$ 中提取潜在表示 $z$ 并重构出 $\hat{x}_0$。这一步本质是一个标准的 VAE 训练任务，优化相对简单。</li>
<li>第二阶段固定 VAE 的参数（不再训练），只使用 VAE 训练好的模型表示。然后再单独运行扩散模型，这样就不会被 VAE 的动态变化扰动。</li>
</ol>
<p>说明了什么，说明了之前说的端对端联合优化没能实现，还是只能使用传统思想，固定一个，训练另一个，VAE 提供一个初步结果，而 DDPM 专注于细化这些结果，从而结合两者的优势。</p>
<h4 id="总结一下这三点简化">总结一下这三点简化<a hidden class="anchor" aria-hidden="true" href="#总结一下这三点简化">#</a></h4>
<ul>
<li>
<p>条件信号 $y$ 被简化为目标数据 $x_0$</p>
</li>
<li>
<p>第二阶段扩散模型的输入是 VAE 重构结果 $\hat{x}_0$</p>
</li>
<li>
<p>使用顺序的两阶段训练方式，固定一个，训练另一个</p>
</li>
</ul>
<p>从这里我们可以看出，理论很美好，实践很困难啊!</p>
<h3 id="vae-参数化的选择">VAE 参数化的选择<a hidden class="anchor" aria-hidden="true" href="#vae-参数化的选择">#</a></h3>
<p>在 VAE 的选择上，论文决定只使用最基本、最传统的 VAE 构型（单随机层的简单 VAE），而不是使用更复杂的多层变种：</p>
<ul>
<li>使用复杂的 VAE（比如多层潜在变量、多级别特征抽取）可以潜在地获得更强大的表示能力，但也会使潜在空间更难解释、更不稳定，从而不利于对潜在表示 $z$ 的直观控制和理解。</li>
<li>简单的 VAE 虽然表达能力或许弱一些，但潜在空间更易于理解和利用，符合 DiffuseVAE 利用潜在空间来控制全局特性的初衷。</li>
</ul>
<h3 id="ddpm扩散模型两种设计假设">DDPM扩散模型两种设计假设<a hidden class="anchor" aria-hidden="true" href="#ddpm扩散模型两种设计假设">#</a></h3>
<p>在将 VAE 重构的 $\hat{x}_0$ 与扩散模型相结合时，有两种主要的设计思路（两种公式假设），分别在正向与逆向过程的依赖关系上做出了不同的简化。</p>
<h4 id="第一种简化假设">第一种简化假设：<a hidden class="anchor" aria-hidden="true" href="#第一种简化假设">#</a></h4>
<ol>
<li>
<p><strong>正向过程的条件独立性</strong>：</p>
<p>假设正向加噪过程 $q(x_{1:T}|x_0,z)$ 对 $z$ 和 $\hat{x}<em>0$ 条件独立，也就是正向过程不需要使用 $z$ 或 $\hat{x}<em>0$的信息，只从原始数据 $x_0$ 通过标准扩散加噪就行：
$$
q(x</em>{1:T}|x_0, z) \approx q(x</em>{1:T}|x_0)
$$
也就是说，加噪过程与 VAE 相关信息无关，依旧是传统的 DDPM 算法的扩散加噪，从原图像 $x_0$ 开始，每一步只是简单地注入噪声，潜在空间一点没用上。</p>
</li>
<li>
<p><strong>逆向过程的依赖性</strong>：</p>
<p>逆向去噪过程中，扩散模型使用VAE 的重构结果 $\hat{x}<em>0$ 作为参考信息，而不是直接依赖潜在表示 $z$，即：
$$
p(x</em>{0:T}|z) \approx p(x_{0:T}|\hat{x}_0)
$$
在每个去噪步骤中，把 $ \hat{x}_0 $ 与当前带噪声的图像 $ x_t $ 一并拼接后 $[,x_t,, \hat{x}<em>0,]$ 输入到扩散网络中，让网络预测噪声或直接预测 $x</em>{t-1}$。$ \hat{x}_0 $ 提供“目标图像应该长什么样”的参考，而 $ x_t $ 是当前带噪声的图像，网络学着如何将 $ x_t $ 去噪并向 $ \hat{x}_0 $ 靠拢。</p>
</li>
</ol>
<h4 id="第二种简化假设">第二种简化假设：<a hidden class="anchor" aria-hidden="true" href="#第二种简化假设">#</a></h4>
<ol>
<li>
<p><strong>正向过程的依赖性</strong>：</p>
<p>这里正向过程被设计为显式依赖于 VAE 重构结果 $\hat{x}<em>0$：
$$
q(x</em>{1:T}|x_0, z) \approx q(x_{1:T}|\hat{x}_0, x_0)
$$
这意味着在每一步加噪过程中，模型会直接结合 $x_0$ 和 $\hat{x}_0$ 的信息，即把 $ \hat{x}_0 $ 也作为输入条件，使加噪分布围绕着 $ \hat{x}_0 $ 进行。</p>
</li>
<li>
<p><strong>逆向过程的依赖性</strong>：</p>
<p>和第一种简化假设相同：
$$
p(x_{0:T}|z) \approx p(x_{0:T}|\hat{x}_0)
$$</p>
</li>
</ol>
<p><strong>正向过程的具体设计</strong></p>
<p>在第二种假设中，主要针对了正向过程中的输入条件，把 VAE 重构结果 $\hat{x}_0$ 也包含在加噪过程中，我们先和标准的DDPM比较一下:</p>
<ul>
<li>
<p><strong>在标准 DDPM 中</strong>：如果不断加大噪声，到达 $x_T$ 时，理想情况下 $x_T$ 就分布于一个各向同性的高斯噪声 $\mathcal{N}(0, \mathbf{I})$</p>
</li>
<li>
<p><strong>在第二种假设中:</strong> 当 $t \to T$ 且噪声足够大时，$q(x_T \mid x_0, \hat{x}_0) \approx \mathcal{N}\bigl(\hat{x}_0, \mathbf{I}\bigr) $  ，我们先给出结论，后续给出推导过程</p>
</li>
</ul>
<p>也就是说，最终的 带噪样本分布是围绕 $ \hat{x}_0 $ 的一个近似单位方差的高斯，而不是围绕 0，成为了加噪和去噪的中心参考点。这样有一个好处，样本都时刻记得有一个 $ \hat{x}_0 $ 作为 目标中心，因而在逆向还原时更容易保持与 $ \hat{x}_0 $ 的结构或风格一致。</p>
<p>但是实际上没有这么高深，其想法很简单，DDPM 算法中输入 A 输出也是 A，在 DiffuseVAE 中输入 VAE 重构结果 $\hat{x}_0$ 输出肯定也得是 $\hat{x}_0$ ，然后给出标准答案（原图）$x_0$ 作为参考。</p>
<p><strong>正向过程详细数学推导</strong></p>
<p>假设对正向过程每一步都采用变分推断中常用的高斯分布假设：
$$
q(x_t|x_{t-1}, \hat{x}<em>0) = \mathcal{N}(\sqrt{1-\beta_t}x</em>{t-1} + (1-\sqrt{1-\beta_t})\hat{x}_0, \beta_t \mathbf{I})
$$</p>
<ul>
<li>从 $x_{t-1}$ 到 $x_t$ 会注入高斯噪声，方差为 $\beta_t \mathbf{I}$</li>
<li>均值项中不仅有 $\sqrt{1-\beta_t},x_{t-1}$，还额外加上 $(1 - \sqrt{1-\beta_t}),\hat{x}_0$
<ul>
<li>若 $\beta_t$ 很小，则 $\sqrt{1-\beta_t} \approx 1$，此时均值主要受 $x_{t-1}$ 控制，$ \hat{x}_0 $ 占的比重较小</li>
<li>随着 $\beta_t$ 增大，每一步加噪时，$ \hat{x}_0 $ 占的权重会逐渐明显，让 $x_t$ 更靠近 $ \hat{x}_0 $</li>
</ul>
</li>
</ul>
<p>在每个时间步中，$x_t$ 的生成不仅依赖于前一时间步 $x_{t-1}$，还结合了 $\hat{x}_0$ 的全局信息，即 $x_t$ 由原始数据 $x_0$ 和 VAE 重构 $\hat{x}_0$ 的加权和决定的。</p>
<p>第一步 $t = 1$ 的加噪过程可以写为:
$$
q(x_1|x_0, \hat{x}_0) = \mathcal{N}(\sqrt{1-\beta_1}x_0 + \hat{x}_0, \beta_1 \mathbf{I})
$$
这样把原图像 $x_0$ 的主要信息留下，同时把 $ \hat{x}_0 $ <strong>一次性地</strong>注入到分布里。</p>
<p><strong>正向条件边缘分布</strong></p>
<p>通过连续乘法展开，可得到该正向过程在第 $t$ 步时的<strong>边缘分布</strong>：
$$
q(x_t \mid x_0, \hat{x}_0)
= \mathcal{N}\Bigl(\sqrt{\bar{\alpha}_t}, x_0 + \hat{x}_0,;\bigl(1-\bar{\alpha}_t\bigr)\mathbf{I}\Bigr)
$$
其中
$$
\bar{\alpha}<em>t = \prod</em>{i=1}^t (1 - \beta_i)
$$</p>
<ul>
<li>
<p>当 $t$ 逐渐增大，$\bar{\alpha}_t$ 会变得很小（因为 $(1 - \beta_i)$ 都小于 1，相乘会衰减），于是 $\sqrt{\bar{\alpha}_t} \approx 0$。</p>
</li>
<li>
<p>故当 $t$ 到达 $T$ 时，$\bar{\alpha}_T \approx 0$，即可得到
$$
q(x_T \mid x_0, \hat{x}_0) \approx \mathcal{N}\bigl(\hat{x}_0, \mathbf{I}\bigr)
$$</p>
</li>
</ul>
<h2 id="实现">实现<a hidden class="anchor" aria-hidden="true" href="#实现">#</a></h2>
<h3 id="在不同潜在空间进行插值的差异">在不同潜在空间进行插值的差异<a hidden class="anchor" aria-hidden="true" href="#在不同潜在空间进行插值的差异">#</a></h3>
<p>如前所述，DiffuseVAE 中包含两种潜在表示：</p>
<ul>
<li><strong>低维潜在向量</strong> $z_\text{vae}$（来自第1阶段 VAE）</li>
<li><strong>高维潜在表示</strong> $x_{1:T}$（来自第2阶段 DDPM 逆向过程）</li>
</ul>
<p>在实验中，我们分别在 $z_\text{vae}$ 空间和 $x_T$ 空间（即 DDPM 逆向过程的初始分布采样空间）中进行插值，直观地对比了两种插值方式对合成结果所产生的影响。</p>
<p><strong>在 $z_\text{vae}$ 空间进行插值</strong></p>
<ul>
<li><strong>插值公式</strong><br>
$$
\tilde{z}<em>\text{vae}
;=; \lambda z</em>\text{vae}^{(1)} ;+; (1 - \lambda),z_\text{vae}^{(2)}
\quad 0 &lt; \lambda &lt; 1
$$
将插值得到的 $\tilde{z}_\text{vae}$ 输入到 DiffuseVAE 中，先通过 VAE 生成模糊初始图，再进入扩散DDPM细化过程，得到最终清晰结果。</li>
</ul>
<p><strong>在 $x_T$ 空间进行插值</strong></p>
<ul>
<li><strong>插值公式</strong><br>
$$
\tilde{x}_T
;=; \lambda,x_T^{(1)}
;+; (1 - \lambda),x_T^{(2)}\quad 0 &lt; \lambda &lt; 1
$$
其中 $x_T^{(1)}$ 与 $x_T^{(2)}$ 是从 DDPM 的初始分布 $p(x_T)$ 中分别采样得到的高维表示（形状与图像相同）。随后，$\tilde{x}_T$ 通过第2阶段逆向过程逐步去噪，生成最终图像。</li>
</ul>
<p>$z_\text{vae}$ 空间插值用于全局结构的控制，$x_T$ 空间插值则更多地用于细节层面的操作。</p>
<h2 id="diffusevae-在采样速度与质量权衡中的表现">DiffuseVAE 在采样速度与质量权衡中的表现<a hidden class="anchor" aria-hidden="true" href="#diffusevae-在采样速度与质量权衡中的表现">#</a></h2>
<p><strong>扩散模型（DDPM）</strong> 通常面临“<strong>采样步数</strong>”与“<strong>样本质量</strong>”之间的两难：</p>
<ul>
<li>采样步数越多（如 1000 步），生成样本质量往往越好，但速度更慢；</li>
<li>采样步数越少（如 10、25、50 步），采样速度更快，但生成质量低。</li>
</ul>
<p><strong>DiffuseVAE 在低采样步数时更优</strong></p>
<ul>
<li>当 $T$ 从 10 到 100 时，DiffuseVAE 的 FID 分数始终优于无条件 DDPM，特别是在 $T=25$ 和 $T=50$ 时优势明显。</li>
</ul>
<p><strong>无条件 DDPM 在极高步数（$T=1000$）时更优</strong></p>
<ul>
<li>当将采样步数提升到训练时常用的 1000 步，纯 DDPM 的最终 FID 略好于 DiffuseVAE。</li>
<li>论文中推测原因在于 <strong>VAE 的先验空洞问题（prior-hole problem）</strong>：VAE 的先验分布 $p(z)$ 与后验 $q(z)$ 不匹配，部分潜在区域对应的样本质量太差，DDPM 对这些样本的细化也无能为力，从而整体 FID 拉低。</li>
</ul>
<p><strong>通过后拟合（Ex-PDE 等）可显著改善</strong></p>
<ul>
<li>若在训练后，对 VAE 潜在编码分布用更灵活的模型（如高斯混合模型 GMM）进行拟合并从中采样，可以缓解先验空洞问题。结果表示在 $T=1000$ 步时其结果大幅改善</li>
</ul>
<h2 id="与最先进模型的比较">与最先进模型的比较<a hidden class="anchor" aria-hidden="true" href="#与最先进模型的比较">#</a></h2>
<p><strong>在 CIFAR-10 上</strong></p>
<p><img loading="lazy" src="/Users/zehua/Downloads/diffuseVAE1.png" alt="diffuseVAE1"  />
</p>
<p>接下来我们直接以成绩说话。</p>
<p><strong>VAE Baseline</strong> ：FID 139.50，IS 3.23。单纯的VAE是当之无愧的垫底。</p>
<p><strong>DiffuseVAE</strong> : FID 在 2.62 - 2.95 之间，IS 大约在 9.5 - 9.7 之间，比单纯的 DDPM 效果好一些。在众多算法中排前列，但是我认为这是DDPM的功劳。</p>
<p><strong>在 CelebA-64x基准上</strong></p>
<img src="/Users/zehua/Downloads/diffuseVAE3.png" alt="diffuseVAE2" style="zoom: 67%;" />
<p>我们可见 DIffuseVAE 并没有优于 DDPM，这是不应该的。</p>
<p><strong>在 CelebA-256x基准上</strong></p>
<img src="/Users/zehua/Downloads/diffuseVAE4.png" alt="diffuseVAE2" style="zoom:67%;" />
<p>还行，主要是靠的 DDPM。</p>
<p>主要是DDPM的功劳</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://zehua.eu/zh/posts/signal_cn/%E5%8F%8D%E9%97%AE%E9%A2%98-tp3%E7%BD%91%E9%A1%B5%E7%89%88/">
    <span class="title">« 上一页</span>
    <br>
    <span>反问题 TP3</span>
  </a>
  <a class="next" href="http://zehua.eu/zh/posts/signal_cn/%E5%8B%92%E8%AE%A9%E5%BE%B7%E5%8F%98%E6%8D%A2/">
    <span class="title">下一页 »</span>
    <br>
    <span>勒让德变换与半二次优化方法</span>
  </a>
</nav>

  </footer>
</article>

<div class="post-password"></div>
  
</div>
    </main>
    
<footer class="footer">
        <span><a href="https://github.com/adityatelange/hugo-PaperMod/graphs/contributors">PaperMod</a></span> · 


    <span>
        
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>  
        
    </span>
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <br>
    <span id="busuanzi_container_page_pv" style='display:none'>
        一共有<span id="busuanzi_value_page_pv"></span>人来过这里
    </span>
    · <span id="last_change">
        最后更新于2024年12月14日
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
